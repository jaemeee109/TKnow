<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="ticketnow.modules.board.mapper.BoardMapper">

  <!-- ===== Board ===== -->
<!-- AFTER -->
<insert id="insertBoard"
        parameterType="ticketnow.modules.board.domain.BoardVO"
        useGeneratedKeys="true"
        keyProperty="boardId">
  INSERT INTO board
    (member_id, board_title, board_content, board_reaction_type, category_type, created_at, updated_at)
  VALUES
    (#{member.memberId}, #{boardTitle}, #{boardContent}, #{boardReactionType}, #{categoryType}, NOW(), NOW())
</insert>

  <update id="updateBoard" parameterType="ticketnow.modules.board.domain.BoardVO">
    UPDATE board
       SET board_title = #{boardTitle},
           board_content = #{boardContent},
           category_type = #{categoryType},
           updated_at = NOW()
     WHERE board_id = #{boardId}
  </update>

 <select id="selectBoardById" parameterType="long" resultType="ticketnow.modules.board.domain.BoardVO">
  SELECT
    b.board_id      AS boardId,
    b.member_id     AS `member.memberId`,
    b.board_title   AS boardTitle,
    b.board_content AS boardContent,
    b.board_reaction_type AS boardReactionType,
    b.category_type AS categoryType,
    b.created_at    AS createdAt,
    b.updated_at    AS updatedAt
  FROM board b
  WHERE b.board_id = #{boardId}
</select>


  <select id="countReplies" parameterType="long" resultType="int">
    SELECT COUNT(*) FROM reply WHERE board_id = #{boardId}
  </select>

  <!-- 회원 목록 -->
  <select id="selectMyBoards"  resultType="ticketnow.modules.board.dto.inquiry.InquiryListItemDTO">
    SELECT
      b.board_id AS boardId,
      b.board_title AS title,
      (SELECT COUNT(*) FROM reply r WHERE r.board_id = b.board_id) AS replyCount,
      b.created_at AS createdAt
    FROM board b
    WHERE b.member_id = #{memberId}
    ORDER BY b.created_at DESC
    LIMIT #{limit} OFFSET #{offset}
  </select>

  <select id="countMyBoards" resultType="long">
    SELECT COUNT(*) FROM board WHERE member_id = #{memberId}
  </select>

  <!-- 관리자 목록 -->
  <select id="selectAllBoards" resultType="ticketnow.modules.board.dto.inquiry.InquiryListItemDTO">
    SELECT
      b.board_id AS boardId,
      b.board_title AS title,
      (SELECT COUNT(*) FROM reply r WHERE r.board_id = b.board_id) AS replyCount,
      b.created_at AS createdAt
    FROM board b
    ORDER BY b.created_at DESC
    LIMIT #{limit} OFFSET #{offset}
  </select>

  <select id="countAllBoards" resultType="long">
    SELECT COUNT(*) FROM board
  </select>

  <!-- ===== Reply ===== -->
<insert id="insertReply"
        parameterType="ticketnow.modules.board.domain.ReplyVO"
        useGeneratedKeys="true"
        keyProperty="replyId">
  INSERT INTO reply
    (member_id, board_id, reply_content, created_at, updated_at)
  VALUES
    (#{member.memberId}, #{board.boardId}, #{replyContent}, NOW(), NOW())
</insert>

  <update id="updateReply" parameterType="ticketnow.modules.board.domain.ReplyVO">
    UPDATE reply
       SET reply_content = #{replyContent},
           updated_at = NOW()
     WHERE reply_id = #{replyId}
  </update>

  <delete id="deleteReply" parameterType="long">
    DELETE FROM reply WHERE reply_id = #{replyId}
  </delete>

<select id="selectReplies" parameterType="long" resultType="ticketnow.modules.board.domain.ReplyVO">
  SELECT
    r.reply_id      AS replyId,
    r.member_id     AS `member.memberId`,
    r.board_id      AS `board.boardId`,
    r.reply_content AS replyContent,
    r.created_at    AS createdAt,
    r.updated_at    AS updatedAt
  FROM reply r
  WHERE r.board_id = #{boardId}
  ORDER BY r.created_at ASC
</select>


<select id="selectReplyById" parameterType="long" resultType="ticketnow.modules.board.domain.ReplyVO">
  SELECT
    r.reply_id      AS replyId,
    r.member_id     AS `member.memberId`,
    r.board_id      AS `board.boardId`,
    r.reply_content AS replyContent,
    r.created_at    AS createdAt,
    r.updated_at    AS updatedAt
  FROM reply r
  WHERE r.reply_id = #{replyId}
</select>

</mapper>
