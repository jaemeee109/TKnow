<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="ticketnow.modules.common.mapper.image.ImageMapper">

  <!--
    - 전역 설정(mapUnderscoreToCamelCase=true)로 snake_case → camelCase 자동 매핑
    - 테이블명/컬럼명은 schema.sql과 정확히 일치해야 합니다.
  -->

  <insert id="insertImage" parameterType="ticketnow.modules.common.domain.ImageVO">
    INSERT INTO image
      (img_uuid, img_ext, orgin_name, file_name, img_url, img_type, img_sort, is_primary,
       board_id, member_id, ticket_id, created_at, updated_at)
    VALUES
      (#{imageUuid}, #{imageExt}, #{orginName}, #{fileName}, #{imageUrl}, #{imageType},
       #{imageSort}, #{isPrimary},
       #{board.boardId}, #{member.memberId}, #{ticket.ticketId},
       NOW(), NOW())
  </insert>

  <update id="updateImageMeta" parameterType="ticketnow.modules.common.domain.ImageVO">
  UPDATE image
  <set>
    is_primary = CASE WHEN #{isPrimary} IS NULL THEN 0 ELSE #{isPrimary} END,
    <if test="imgSort != null">
      img_sort = #{imgSort},
    </if>
    <if test="imgType != null">
      img_type = #{imgType},
    </if>
    updated_at = NOW()
  </set>
  WHERE img_uuid = #{imgUuid}
</update>

  <delete id="deleteImageByUuid">
    DELETE FROM image WHERE img_uuid = #{imageUuid}
  </delete>

  <select id="selectImagesByBoard" resultType="ticketnow.modules.common.domain.ImageVO">
    SELECT *
      FROM image
     WHERE board_id = #{boardId}
     ORDER BY is_primary DESC, img_sort ASC, created_at ASC
  </select>

  <select id="selectImagesByMember" resultType="ticketnow.modules.common.domain.ImageVO">
    SELECT *
      FROM image
     WHERE member_id = #{memberId}
     ORDER BY is_primary DESC, img_sort ASC, created_at ASC
  </select>

  <select id="selectImagesByTicket" resultType="ticketnow.modules.common.domain.ImageVO">
    SELECT *
      FROM image
     WHERE ticket_id = #{ticketId}
     ORDER BY is_primary DESC, img_sort ASC, created_at ASC
  </select>
  
    <select id="selectImagesByReply" resultType="ticketnow.modules.common.domain.ImageVO">
    SELECT * FROM image
     WHERE reply_id = #{replyId}
     ORDER BY is_primary DESC, img_sort ASC, created_at ASC
  </select>

  <select id="selectPrimaryImageByTicket" resultType="ticketnow.modules.common.domain.ImageVO">
    SELECT *
      FROM image
     WHERE ticket_id = #{ticketId}
     ORDER BY is_primary DESC, img_sort ASC, created_at ASC
     LIMIT 1
  </select>

</mapper>
