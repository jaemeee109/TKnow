<?xml version="1.0" encoding="UTF-8"?>
<beans:beans xmlns="http://www.springframework.org/schema/security"
  xmlns:beans="http://www.springframework.org/schema/beans"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="
    http://www.springframework.org/schema/beans     http://www.springframework.org/schema/beans/spring-beans.xsd
    http://www.springframework.org/schema/security  http://www.springframework.org/schema/security/spring-security.xsd">

  <!-- === 1) CORS 설정 (프론트에서 오는 요청을 허용할 규칙 등록) === -->
  <!-- URL 패턴별 CORS 규칙 저장소 -->
  <beans:bean id="corsSource" class="org.springframework.web.cors.UrlBasedCorsConfigurationSource">
    <beans:property name="corsConfigurations">
      <beans:map>
        <beans:entry key="/**">  <!-- 모든 경로(/**)에 동일 규칙 적용 -->
          <beans:bean class="org.springframework.web.cors.CorsConfiguration">  <!-- CORS 구체 규칙 객체 -->
            <beans:property name="allowCredentials" value="true"/>  <!-- 쿠키/Authorization 헤더 포함 요청 허용 -->
            
            <!-- allowedOrigins는 개발/운영 도메인에 맞게 수정 -->
            <beans:property name="allowedOrigins">  <!-- 허용할 Origin(도메인) 목록 -->
              <beans:list>
                <beans:value>http://localhost:3000</beans:value>  <!-- 로컬 React 개발 서버 -->
              </beans:list>
            </beans:property>
            
            <!-- 허용할 HTTP 메서드 -->
            <beans:property name="allowedMethods">          
              <beans:list>
                <beans:value>GET</beans:value>  <!-- 조회 허용 -->
                <beans:value>POST</beans:value> <!-- 생성/로그인 등 허용 -->
                <beans:value>PUT</beans:value> <!-- 수정 허용 -->
                <beans:value>DELETE</beans:value> <!-- 삭제 허용 -->
                <beans:value>OPTIONS</beans:value>  <!-- CORS preflight(사전요청) 허용 -->
              </beans:list>  
            </beans:property>
            
            
              <!-- 클라이언트가 보낼 수 있는 요청 헤더 -->
            <beans:property name="allowedHeaders">
              <beans:list>
                <beans:value>Authorization</beans:value>    <!-- JWT 토큰 헤더 -->
                <beans:value>Content-Type</beans:value> <!-- JSON 본문 전송 -->
                <beans:value>X-Requested-With</beans:value>  <!-- AJAX 식별 -->
                <beans:value>X-Request-Id</beans:value>  <!-- 요청 추적용 커스텀 헤더 -->
              </beans:list>
            </beans:property>
            
               <!-- 브라우저에서 읽기 허용할 응답 헤더 -->
            <beans:property name="exposedHeaders">  
              <beans:list>
                <beans:value>Authorization</beans:value>   <!-- 필요 시 서버가 토큰을 응답 헤더로 보낼 때 노출 -->
              </beans:list>
            </beans:property>
          </beans:bean>
        </beans:entry>
      </beans:map>
    </beans:property>
  </beans:bean>

 <!-- 실제로 CORS를 처리할 필터 -->
  <beans:bean id="corsFilter" class="org.springframework.web.filter.CorsFilter">
    <beans:constructor-arg ref="corsSource"/>
  </beans:bean>
  

 <!-- === JWT 관련 Bean 등록 토큰 생성/검증 도구, 인증/인가 실패 핸들러, 요쳥 필터 === -->
  <!-- JWT 생성/검증 유틸 -->
  <beans:bean id="jwtTokenProvider" class="ticketnow.core.auth.util.JwtTokenProvider"  init-method="init"> 
   <!-- 서명 비밀키(환경변수/프로퍼티로 주입 권장) 
   		 HS256은 최소 32바이트 이상 권장이므로 기본값을 충분히 길게 두기-->
    <beans:property name="secret" value="${jwt.secret:ticketnow-secret-key-0123456789-ABCD}"/>    
    <!-- 액세스 토큰 만료(기본 1시간) -->
    <beans:property name="accessTokenValidityMs" value="${jwt.access.ms:3600000}"/>    
      <!-- 리프레시 토큰 만료(기본 14일) -->
    <beans:property name="refreshTokenValidityMs" value="${jwt.refresh.ms:1209600000}"/> <!-- 14d -->
  </beans:bean>
  
  
	<!-- 미인증(401) 응답 핸들러 -->
   <beans:bean id="jwtAuthenticationEntryPoint" class="ticketnow.core.auth.handler.JwtAuthenticationEntryPoint"/>
   <!-- 권한부족(403) 응답 핸들러 -->
     <beans:bean id="jwtAccessDeniedHandler" class="ticketnow.core.auth.handler.JwtAccessDeniedHandler"/>
   <!-- 매 요청마다 JWT 검사 필터 Bean (OncePerRequestFilter) -->
  <beans:bean id="jwtAuthenticationFilter" class="ticketnow.core.auth.filter.JwtAuthenticationFilter">
    <!-- JwtAuthenticationFilter#setJwtTokenProvider(...) -->
    <beans:property name="jwtTokenProvider" ref="jwtTokenProvider"/>
    <!-- JwtAuthenticationFilter#setBlacklistTokenMapper(...) -->
    <beans:property name="blacklistTokenMapper" ref="blacklistTokenMapper"/>
  </beans:bean>

  

  <!-- 3) AuthenticationManager : 인증 처리 핵심 컴포넌트 -->
  <authentication-manager alias="authenticationManager"/>

  <!-- 4) HTTP 보안 규칙 : 어떤 URL이 공개/보호되는지, 어떤 필터/정책을 적용할지 정의 -->
    <!-- 인증 필요하지만 토큰 없을 때 401로 보낼 핸들러 -->
   <http entry-point-ref="jwtAuthenticationEntryPoint"
     create-session="stateless"
     use-expressions="true"> 
        <!-- create-session="stateless: 서버 세션을 만들지 않음(REST/JWT 권장) -->
        <!-- use-expressions="true" : 인증은 됐지만 권한 부족 시 403 핸들러 -->
    <cors configuration-source-ref="corsSource"/>  <!-- 위에서 정의한 CORS 정책을 보안 체인에 적용 -->
    <csrf disabled="true"/>  <!-- CSRF 비활성화: 폼 세션 대신 토큰 방식 사용 -->

	<!-- ========================= 접근권한 설정  ========================= -->
   
    <!-- 전채공개 URL   -->
    <intercept-url pattern="/auth/**" access="permitAll"/>  <!-- 로그인/토큰발급용 -->
    
	<!--  URL별 접근권한 -->
	<!--예시) <intercept-url pattern="/board/delete/**" access="hasAnyRole('ADMIN','USER')"/> -->
        
    <!-- 관리자 전용 -->
    <!--예시) <intercept-url pattern="/admin/**" access="hasRole('ADMIN')"/> -->
    
     <!-- 그 외는 인증 필요 -->
    <intercept-url pattern="/**" access="isAuthenticated()"/> <!-- JWT 유효해야 통과 -->    
    
	<!-- ========================= 접근권한 설정 종료  ========================= -->
    <!-- 사용자 정의 JWT 필터 삽입 -->
    <!-- 스프링 기본 인증 필터보다 먼저 수행 -->
       <custom-filter ref="jwtAuthenticationFilter" before="FORM_LOGIN_FILTER"/>

  	</http>

</beans:beans>
