<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="ticketnow.modules.pay.mapper.PayMapper">


  
  <!-- [카드] 즉시 승인 삽입 -->
  <insert id="insertCardApproved" parameterType="ticketnow.modules.pay.domain.PayVO">
    INSERT INTO pay
      (member_id, orders_id, pay_method, pay_amount, pay_status,
       pg_provider, pg_tid, approval_no, approved_at,
       created_at, updated_at)
    VALUES
      (#{member.memberId}, #{orders.ordersId}, #{payMethod}, #{payAmount}, #{payStatus},
       #{pgProvider}, #{pgTid}, #{approvalNo}, NOW(),
       NOW(), NOW())
  </insert>
  

  <!-- [무통장] 가상계좌 발급(READY) -->
  <insert id="insertVBankReady" parameterType="ticketnow.modules.pay.domain.PayVO">
    INSERT INTO pay
      (member_id, orders_id, pay_method, pay_amount, pay_status,
       pg_provider, virtual_account, created_at, updated_at)
    VALUES
      (#{member.memberId}, #{orders.ordersId}, #{payMethod}, #{payAmount}, #{payStatus},
       #{pgProvider}, #{virtualAccount}, NOW(), NOW())
  </insert>
  

  <!-- [무통장] 입금 승인 처리 -->
  <update id="approveVBank" parameterType="long">
    UPDATE pay
       SET pay_status = 'APPROVED',
           va_paid_at = NOW(),
           updated_at = NOW()
     WHERE orders_id = #{ordersId}
       AND pay_method = 'VBANK'
     ORDER BY pay_id DESC
     LIMIT 1
  </update>
  

  <!-- 주문 상태 갱신 (예: PAID) -->
  <update id="updateOrdersStatus">
    UPDATE orders
       SET orders_status = #{status},
           updated_at = NOW()
     WHERE orders_id = #{ordersId}
  </update>
  

  <!-- 좌석 상태를 PAID로 (해당 주문에 연결된 모든 좌석) -->
  <update id="updateSeatStatusPaidByOrdersId" parameterType="long">
    UPDATE seat s
    JOIN order_ticket ot ON ot.seat_id = s.seat_id
    SET s.seat_status = 'PAID',
        s.updated_at = NOW()
    WHERE ot.orders_id = #{ordersId}
  </update>


  <!-- 결제 결과 조회 (주문 단건 기준 최신 1건) -->
  <select id="selectPayResultByOrdersId" parameterType="long"
          resultType="ticketnow.modules.pay.dto.PayResultDTO">
    SELECT
      p.pay_id          AS payId,
      p.orders_id       AS ordersId,
      p.member_id       AS memberId,
      p.pay_method      AS payMethod,
      p.pay_amount      AS payAmount,
      p.pay_status      AS payStatus,
      p.pg_provider     AS pgProvider,
      p.pg_tid          AS pgTid,
      p.approval_no     AS approvalNo,
      p.approved_at     AS approvedAt,
      p.virtual_account AS virtualAccount,
      p.va_paid_at      AS vaPaidAt,
      p.created_at      AS createdAt,
      p.updated_at      AS updatedAt
    FROM pay p
    WHERE p.orders_id = #{ordersId}
    ORDER BY p.pay_id DESC
    LIMIT 1
  </select>

</mapper>
