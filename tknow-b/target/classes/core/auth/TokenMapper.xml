<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="ticketnow.core.auth.mapper.TokenMapper">

  <insert id="insert" parameterType="ticketnow.core.auth.domain.TokenVO" useGeneratedKeys="true" keyProperty="tokenNo">
    INSERT INTO token (member_id, refreshToken, expiresAt, revokedAt, created_at, updated_at)
    VALUES (#{member.memberId}, #{refreshToken}, #{expiresAt}, #{revokedAt}, NOW(), NOW())
  </insert>

  <update id="revokeByRefreshToken">
    UPDATE token
       SET revokedAt = NOW(), updated_at = NOW()
     WHERE refreshToken = #{refreshToken}
  </update>

  <select id="existsValidRefresh" resultType="int">
    SELECT COUNT(1)
      FROM token
     WHERE refreshToken = #{refreshToken}
       AND (revokedAt IS NULL)
       AND (expiresAt > NOW())
  </select>

</mapper>
